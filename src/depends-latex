#!/bin/sh
STEMS=""
COMPILELATEX=$(dirname "$0")/compile-latex
if [ ! -r "$COMPILELATEX" ]; then
    COMPILELATEX=$(which compile-latex)
fi

echo "# Generated by make depends" > gitignore
echo "# Generated by make depends" > Makefile2

while [ -n "$1" ]&&[ "$1" != "--" ]; do
    STEMS="$STEMS $(basename $1 .pdf)"
    shift
done

for i in $STEMS; do
    echo "GENERATED$i = \\" >> Makefile2
    ${COMPILELATEX} ${i}.tex
    ${COMPILELATEX} --internals --outputs --separator '\
' ${i}.tex >> Makefile2
    echo >> Makefile2
    echo "SOURCE$i = \\" >> Makefile2
    ${COMPILELATEX} --depends --separator '\
' ${i}.tex >> Makefile2
    echo >> Makefile2
    echo -n "/" >> gitignore
    ${COMPILELATEX} --internals --outputs --separator '
/' ${i}.tex >> gitignore
done


if [ "$1" = "--" ]; then
    shift
fi
echo "# Targets not generated by pdflatex" >> gitignore
for i in "$@"; do echo "/$i" >> gitignore; done

echo '# End of make depends' >> Makefile2
echo '# End of make depends' >> gitignore

if grep -q '^# End of make depends' Makefile; then sed -ne '/^# End of make depends/,$ p' < Makefile |tail -n +2 >> Makefile2; else cat Makefile >> Makefile2; fi
if grep -q '^# End of make depends' .gitignore; then sed -ne '/^# End of make depends/,$ p' < .gitignore |tail -n +2 >> Makefile2; else if [ -f .gitignore ]; then cat .gitignore >> gitignore; fi; fi

mv Makefile2 Makefile
mv gitignore .gitignore
